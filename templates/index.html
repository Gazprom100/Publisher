<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher Dashboard</title>
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #FFC107;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --sidebar-width: 250px;
        }

        body {
            background-color: #f5f5f5;
            transition: background-color 0.3s;
        }

        body.dark-theme {
            background-color: #121212;
            color: #ffffff;
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background-color: #ffffff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: all 0.3s;
        }

        .dark-theme .sidebar {
            background-color: #1e1e1e;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: margin-left 0.3s;
        }

        .stats-card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .dark-theme .stats-card {
            background-color: #2d2d2d;
            color: #ffffff;
        }

        .chart-container {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .dark-theme .chart-container {
            background-color: #2d2d2d;
        }

        .channel-card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .channel-card:hover {
            transform: scale(1.02);
        }

        .dark-theme .channel-card {
            background-color: #2d2d2d;
        }

        .theme-switch {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .floating-action-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            padding: 3px 6px;
            border-radius: 50%;
            background: var(--danger-color);
            color: white;
            font-size: 12px;
        }

        .schedule-timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            position: relative;
            padding: 15px;
            margin-left: 30px;
            border-left: 2px solid var(--primary-color);
            margin-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 20px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--primary-color);
        }

        .signal-lamp {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .signal-lamp.green {
            background-color: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }

        .signal-lamp.yellow {
            background-color: #FFC107;
            box-shadow: 0 0 10px #FFC107;
        }

        .signal-lamp.red {
            background-color: #F44336;
            box-shadow: 0 0 10px #F44336;
        }

        .btn-group .btn-outline-secondary {
            border-color: #dee2e6;
            color: #6c757d;
        }

        .btn-group .btn-outline-secondary.active {
            background-color: #6c757d;
            color: #ffffff;
        }

        .dark-theme .btn-group .btn-outline-secondary {
            border-color: #495057;
            color: #adb5bd;
        }

        .dark-theme .btn-group .btn-outline-secondary.active {
            background-color: #495057;
            color: #ffffff;
        }
    </style>
    <!-- Scripts -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
    <!-- Боковое меню -->
    <div class="sidebar">
        <div class="p-4">
            <h4 class="mb-4">
                <i class="material-icons">publish</i>
                Publisher
            </h4>
            <div class="list-group list-group-flush">
                <a href="#dashboard" class="list-group-item list-group-item-action active">
                    <i class="material-icons">dashboard</i>
                    Дашборд
                </a>
                <a href="#analytics" class="list-group-item list-group-item-action">
                    <i class="material-icons">analytics</i>
                    Аналитика
                </a>
                <a href="#channels" class="list-group-item list-group-item-action">
                    <i class="material-icons">rss_feed</i>
                    Каналы
                </a>
                <a href="#schedule" class="list-group-item list-group-item-action">
                    <i class="material-icons">schedule</i>
                    Расписание
                </a>
                <a href="#settings" class="list-group-item list-group-item-action">
                    <i class="material-icons">settings</i>
                    Настройки
                </a>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="main-content">
        <!-- Дашборд -->
        <section id="dashboard" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Дашборд</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" id="refreshData">
                        <i class="material-icons">refresh</i>
                        Обновить
                    </button>
                    <button class="btn btn-primary" data-mdb-toggle="modal" data-mdb-target="#newPostModal">
                        <i class="material-icons">add</i>
                        Новый пост
                    </button>
                </div>
            </div>

            <!-- Статистика -->
            <div class="row g-4 mb-4">
                <!-- Спидометр общей активности -->
                <div class="col-md-6">
                    <div class="stats-card card">
                        <div class="card-body">
                            <h5 class="card-title">Общая активность</h5>
                            <div id="activity-gauge" style="height: 200px;"></div>
                            <div class="d-flex justify-content-between mt-2">
                                <span class="text-muted">Низкая</span>
                                <span class="text-muted">Средняя</span>
                                <span class="text-muted">Высокая</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Тепловая карта активности -->
                <div class="col-md-6">
                    <div class="stats-card card">
                        <div class="card-body">
                            <h5 class="card-title">Активность по дням недели</h5>
                            <div id="activity-heatmap" style="height: 200px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Ключевые метрики -->
                <div class="col-md-3">
                    <div class="stats-card card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-muted">Всего постов</h6>
                                    <h3 id="total-posts">0</h3>
                                </div>
                                <div class="signal-lamp" id="total-posts-signal"></div>
                            </div>
                            <div class="progress mt-3" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" id="total-posts-progress"></div>
                            </div>
                            <small class="text-muted" id="total-posts-trend"></small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="stats-card card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-muted">Сегодня</h6>
                                    <h3 id="posts-today">0</h3>
                                </div>
                                <div class="signal-lamp" id="today-posts-signal"></div>
                            </div>
                            <div class="progress mt-3" style="height: 5px;">
                                <div class="progress-bar bg-success" role="progressbar" id="today-posts-progress"></div>
                            </div>
                            <small class="text-muted" id="today-posts-trend"></small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="stats-card card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-muted">Активные каналы</h6>
                                    <h3 id="active-channels">0</h3>
                                </div>
                                <div class="signal-lamp" id="channels-signal"></div>
                            </div>
                            <div class="progress mt-3" style="height: 5px;">
                                <div class="progress-bar bg-warning" role="progressbar" id="channels-progress"></div>
                            </div>
                            <small class="text-muted" id="channels-trend"></small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="stats-card card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-muted">Охват</h6>
                                    <h3 id="total-reach">0</h3>
                                </div>
                                <div class="signal-lamp" id="reach-signal"></div>
                            </div>
                            <div class="progress mt-3" style="height: 5px;">
                                <div class="progress-bar bg-info" role="progressbar" id="reach-progress"></div>
                            </div>
                            <small class="text-muted" id="reach-trend"></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Графики и диаграммы -->
            <div class="row g-4 mb-4">
                <!-- График активности -->
                <div class="col-md-8">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Активность по времени</h5>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" data-period="day">День</button>
                                <button class="btn btn-sm btn-outline-secondary" data-period="week">Неделя</button>
                                <button class="btn btn-sm btn-outline-secondary active" data-period="month">Месяц</button>
                            </div>
                        </div>
                        <div id="activity-chart"></div>
                    </div>
                </div>

                <!-- Круговые диаграммы -->
                <div class="col-md-4">
                    <div class="chart-container">
                        <h5>Распределение контента</h5>
                        <div id="content-types-chart" class="mb-4"></div>
                        <div id="channels-distribution-chart"></div>
                    </div>
                </div>

                <!-- Метрики эффективности -->
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5>Эффективность публикаций</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div id="engagement-gauge" style="height: 150px;"></div>
                                <p class="text-center">Вовлеченность</p>
                            </div>
                            <div class="col-md-6">
                                <div id="timing-gauge" style="height: 150px;"></div>
                                <p class="text-center">Оптимальность времени</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Прогноз роста -->
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5>Прогноз роста</h5>
                        <div id="growth-forecast"></div>
                    </div>
                </div>
            </div>

            <!-- Ближайшие публикации -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Ближайшие публикации</h5>
                    <div class="schedule-timeline" id="upcoming-posts">
                        <!-- Динамическое содержимое -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Секция управления каналами -->
        <div id="channels" class="section mb-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h2>Управление каналами</h2>
                <button class="btn btn-primary" data-toggle="modal" data-target="#addChannelModal">
                    <i class="fas fa-plus"></i> Добавить канал
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-sm" id="channelsTable">
                    <thead>
                        <tr>
                            <th>Название канала</th>
                            <th>ID канала</th>
                            <th>Лист</th>
                            <th>Подписчики</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Данные о каналах будут добавлены динамически -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Секция ленты -->
        <div id="feed" class="section mb-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h2>Лента постов</h2>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group mr-2">
                        <select id="channelSelector" class="form-control">
                            <!-- Каналы будут добавлены динамически -->
                        </select>
                    </div>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#newPostModal">
                        <i class="fas fa-plus"></i> Новый пост
                    </button>
                </div>
            </div>

            <!-- Вкладки для переключения между будущими и прошлыми постами -->
            <ul class="nav nav-tabs" id="feedTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="future-tab" data-toggle="tab" href="#future-posts">
                        Будущие посты
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="past-tab" data-toggle="tab" href="#past-posts">
                        Опубликованные посты
                    </a>
                </li>
            </ul>

            <!-- Контент вкладок -->
            <div class="tab-content" id="feedTabContent">
                <!-- Будущие посты -->
                <div class="tab-pane fade show active" id="future-posts">
                    <div class="row" id="futurePosts">
                        <!-- Посты будут добавлены динамически -->
                    </div>
                </div>
                
                <!-- Прошлые посты -->
                <div class="tab-pane fade" id="past-posts">
                    <div class="row" id="pastPosts">
                        <!-- Посты будут добавлены динамически -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно нового поста -->
    <div class="modal fade" id="newPostModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Новый пост</h5>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="postForm">
                        <input type="hidden" id="postRow">
                        <div class="form-group">
                            <label>Изображение</label>
                            <div class="custom-file mb-3">
                                <input type="file" class="custom-file-input" id="postImage" accept="image/*">
                                <label class="custom-file-label" for="postImage">Выберите файл</label>
                            </div>
                            <div id="imagePreview" class="text-center mb-3" style="display: none;">
                                <img src="" class="img-fluid" style="max-height: 300px;">
                            </div>
                            <input type="text" class="form-control" id="imageUrl" placeholder="Или вставьте URL изображения">
                        </div>
                        <div class="form-group">
                            <label>Текст поста</label>
                            <div class="input-group">
                                <textarea class="form-control" id="postText" rows="5"></textarea>
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="generateText">
                                        <i class="fas fa-magic"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Дата и время публикации</label>
                            <input type="datetime-local" class="form-control" id="postDateTime">
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="editorConfirm">
                            <label class="form-check-label" for="editorConfirm">Проверено редактором</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="savePost">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления канала -->
    <div class="modal fade" id="addChannelModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить новый канал</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addChannelForm">
                        <div class="form-group">
                            <label for="channelId">ID канала</label>
                            <input type="text" class="form-control" id="channelId" required
                                   placeholder="Например: @mychannel">
                            <small class="form-text text-muted">Укажите ID канала, включая символ @</small>
                        </div>
                        <div class="form-group">
                            <label for="sheetName">Название листа</label>
                            <input type="text" class="form-control" id="sheetName" required
                                   placeholder="Например: Channel1">
                            <small class="form-text text-muted">Название листа в Google Sheets</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="saveChannel">Добавить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Кнопка переключения темы -->
    <button class="btn btn-floating btn-primary theme-switch" id="themeSwitch">
        <i class="material-icons">dark_mode</i>
    </button>

    <!-- MDB JS -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.js"></script>
    
    <script>
        // Инициализация Socket.IO
        const socket = io();

        // Переключение темы
        const themeSwitch = document.getElementById('themeSwitch');
        themeSwitch.addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            const icon = themeSwitch.querySelector('i');
            icon.textContent = document.body.classList.contains('dark-theme') ? 'light_mode' : 'dark_mode';
        });

        // Обновление данных в реальном времени
        socket.on('posts_update', function(data) {
            updateDashboard(data.posts);
        });

        // Функции обновления интерфейса
        function updateDashboard(posts) {
            updateStatistics(posts);
            updateActivityChart(posts);
            updateContentTypesChart(posts);
            updateUpcomingPosts(posts);
        }

        function updateStatistics(posts) {
            const now = new Date();
            const today = posts.filter(p => new Date(p.time).toDateString() === now.toDateString()).length;
            const total = posts.length;
            const activeChannels = new Set(posts.map(p => p.channel)).size;
            const reach = calculateTotalReach(posts);

            document.getElementById('total-posts').textContent = total;
            document.getElementById('posts-today').textContent = today;
            document.getElementById('active-channels').textContent = activeChannels;
            document.getElementById('total-reach').textContent = reach.toLocaleString();
        }

        function updateActivityChart(posts) {
            const hours = Array.from({length: 24}, (_, i) => i);
            const counts = hours.map(hour => 
                posts.filter(p => new Date(p.time).getHours() === hour).length
            );

            const trace = {
                x: hours,
                y: counts,
                type: 'scatter',
                mode: 'lines+markers',
                line: {
                    color: '#2196F3',
                    width: 2
                },
                marker: {
                    color: '#2196F3',
                    size: 6
                }
            };

            const layout = {
                margin: { t: 20, r: 20, b: 40, l: 40 },
                xaxis: {
                    title: 'Час',
                    tickmode: 'array',
                    ticktext: hours.map(h => h.toString().padStart(2, '0') + ':00'),
                    tickvals: hours
                },
                yaxis: {
                    title: 'Количество постов'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                showlegend: false
            };

            Plotly.newPlot('activity-chart', [trace], layout);
        }

        function updateContentTypesChart(posts) {
            const withPhoto = posts.filter(p => p.photo).length;
            const textOnly = posts.length - withPhoto;

            const data = [{
                values: [withPhoto, textOnly],
                labels: ['С фото', 'Только текст'],
                type: 'pie',
                hole: .4,
                marker: {
                    colors: ['#2196F3', '#FFC107']
                }
            }];

            const layout = {
                margin: { t: 20, r: 20, b: 20, l: 20 },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.1
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('content-types-chart', data, layout);
        }

        function updateUpcomingPosts(posts) {
            const now = new Date();
            const upcoming = posts
                .filter(p => new Date(p.time) > now && p.state === 'ожидает')
                .sort((a, b) => new Date(a.time) - new Date(b.time))
                .slice(0, 5);

            const container = document.getElementById('upcoming-posts');
            container.innerHTML = upcoming.map(post => `
                <div class="timeline-item">
                    <div class="d-flex justify-content-between">
                        <h6>${post.channel}</h6>
                        <small>${new Date(post.time).toLocaleString()}</small>
                    </div>
                    <p class="mb-0">${post.text.substring(0, 100)}${post.text.length > 100 ? '...' : ''}</p>
                    ${post.photo ? '<i class="material-icons text-info">image</i>' : ''}
                </div>
            `).join('');
        }

        // Обработка формы нового поста
        document.getElementById('postText').addEventListener('input', function() {
            const charCount = this.value.length;
            document.getElementById('charCount').textContent = charCount;
            if (charCount > 2000) {
                this.value = this.value.substring(0, 2000);
            }
        });

        document.getElementById('validateImage').addEventListener('click', async function() {
            const photoUrl = document.getElementById('postPhoto').value;
            if (!photoUrl) return;

            try {
                const response = await fetch('/api/validate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: photoUrl })
                });
                const data = await response.json();

                if (data.valid) {
                    document.getElementById('photoPreview').style.display = 'block';
                    document.getElementById('photoPreview').querySelector('img').src = photoUrl;
                } else {
                    alert('Неверный формат изображения или превышен размер');
                }
            } catch (error) {
                console.error('Ошибка при проверке изображения:', error);
                alert('Ошибка при проверке изображения');
            }
        });

        document.getElementById('postAnalysis').addEventListener('change', async function() {
            if (!this.checked) {
                document.getElementById('postAnalysisResult').style.display = 'none';
                return;
            }

            const text = document.getElementById('postText').value;
            const photo = document.getElementById('postPhoto').value;

            try {
                const response = await fetch('/api/analyze-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        photo: photo,
                        time: new Date(
                            document.getElementById('postDate').value + 'T' +
                            document.getElementById('postTime').value
                        )
                    })
                });
                const analysis = await response.json();

                const result = document.getElementById('postAnalysisResult');
                result.style.display = 'block';
                result.innerHTML = `
                    <h6>Результаты анализа:</h6>
                    <p>Оценка: ${analysis.score}/3</p>
                    ${analysis.feedback.map(f => `<p>• ${f}</p>`).join('')}
                    ${analysis.optimization_tips.length > 0 ? `
                        <h6>Рекомендации по улучшению:</h6>
                        ${analysis.optimization_tips.map(tip => `<p>• ${tip}</p>`).join('')}
                    ` : ''}
                `;
            } catch (error) {
                console.error('Ошибка при анализе поста:', error);
                alert('Ошибка при анализе поста');
            }
        });

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const [analyticsResponse, channelsResponse, scheduleResponse] = await Promise.all([
                    fetch('/api/analytics'),
                    fetch('/api/channel-health'),
                    fetch('/api/schedule-preview')
                ]);

                const [analytics, channels, schedule] = await Promise.all([
                    analyticsResponse.json(),
                    channelsResponse.json(),
                    scheduleResponse.json()
                ]);

                updateDashboard({
                    posts: analytics.posts || [],
                    channels: channels || {},
                    schedule: schedule || []
                });

                // Заполнение списка каналов
                const channelSelect = document.getElementById('postChannel');
                Object.keys(channels).forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel;
                    option.textContent = channel;
                    channelSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка при загрузке данных:', error);
            }
        });

        // Вспомогательные функции
        function calculateTotalReach(posts) {
            const channels = {};
            posts.forEach(post => {
                if (!channels[post.channel]) {
                    channels[post.channel] = true;
                }
            });
            // Примерный расчет охвата (можно заменить на реальные данные)
            return Object.keys(channels).length * 1000;
        }

        // Функции для работы с каналами
        function loadChannels() {
            fetch('/api/channels')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector('#channelsTable tbody');
                    tbody.innerHTML = '';
                    
                    Object.entries(data).forEach(([channelId, info]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${info.title || 'Н/Д'}</td>
                            <td>${channelId}</td>
                            <td>${info.sheet_name}</td>
                            <td>${info.member_count || 'Н/Д'}</td>
                            <td>
                                <span class="badge badge-${info.status === 'active' ? 'success' : 'danger'}">
                                    ${info.status}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-danger delete-channel" data-channel="${channelId}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Добавляем обработчики для кнопок удаления
                    document.querySelectorAll('.delete-channel').forEach(button => {
                        button.addEventListener('click', function() {
                            const channelId = this.dataset.channel;
                            if (confirm(`Удалить канал ${channelId}?`)) {
                                deleteChannel(channelId);
                            }
                        });
                    });
                })
                .catch(error => console.error('Ошибка загрузки каналов:', error));
        }

        function addChannel(channelId, sheetName) {
            fetch('/api/channels', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    channel_id: channelId,
                    sheet_name: sheetName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Ошибка: ' + data.error);
                } else {
                    $('#addChannelModal').modal('hide');
                    loadChannels();
                    document.getElementById('addChannelForm').reset();
                }
            })
            .catch(error => {
                console.error('Ошибка добавления канала:', error);
                alert('Произошла ошибка при добавлении канала');
            });
        }

        function deleteChannel(channelId) {
            fetch(`/api/channels/${channelId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Ошибка: ' + data.error);
                } else {
                    loadChannels();
                }
            })
            .catch(error => {
                console.error('Ошибка удаления канала:', error);
                alert('Произошла ошибка при удалении канала');
            });
        }

        // Обработчики событий
        document.getElementById('saveChannel').addEventListener('click', function() {
            const channelId = document.getElementById('channelId').value;
            const sheetName = document.getElementById('sheetName').value;
            
            if (!channelId || !sheetName) {
                alert('Заполните все поля');
                return;
            }
            
            addChannel(channelId, sheetName);
        });

        // Загружаем каналы при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadChannels();
        });

        // Функции для работы с лентой
        function loadChannelSelector() {
            fetch('/api/channels')
                .then(response => response.json())
                .then(data => {
                    const selector = document.getElementById('channelSelector');
                    selector.innerHTML = '';
                    
                    Object.entries(data).forEach(([channelId, info]) => {
                        const option = document.createElement('option');
                        option.value = channelId;
                        option.textContent = info.title || channelId;
                        selector.appendChild(option);
                    });
                    
                    // Загружаем ленту для первого канала
                    if (selector.value) {
                        loadChannelFeed(selector.value);
                    }
                });
        }

        function loadChannelFeed(channelId) {
            fetch(`/api/channels/${channelId}/feed`)
                .then(response => response.json())
                .then(data => {
                    // Очищаем контейнеры
                    document.getElementById('futurePosts').innerHTML = '';
                    document.getElementById('pastPosts').innerHTML = '';
                    
                    // Загружаем будущие посты
                    data.future_posts.forEach(post => {
                        const postElement = createPostElement(post, channelId);
                        document.getElementById('futurePosts').appendChild(postElement);
                    });
                    
                    // Загружаем прошлые посты
                    data.past_posts.forEach(post => {
                        const postElement = createPostElement(post, channelId);
                        document.getElementById('pastPosts').appendChild(postElement);
                    });
                });
        }

        function createPostElement(post, channelId) {
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-4';
            
            const card = document.createElement('div');
            card.className = 'card h-100';
            
            // Добавляем изображение если есть
            if (post.photo) {
                const img = document.createElement('img');
                img.src = post.photo;
                img.className = 'card-img-top';
                img.style.height = '200px';
                img.style.objectFit = 'cover';
                card.appendChild(img);
            }
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            
            // Добавляем время публикации
            const time = document.createElement('p');
            time.className = 'card-text text-muted';
            const postDate = new Date(post.time);
            time.textContent = postDate.toLocaleString();
            cardBody.appendChild(time);
            
            // Добавляем текст
            const text = document.createElement('p');
            text.className = 'card-text';
            text.textContent = post.text;
            cardBody.appendChild(text);
            
            // Добавляем статус и подтверждение
            const status = document.createElement('div');
            status.className = 'card-text mt-2';
            status.innerHTML = `
                <span class="badge badge-${post.state === 'выложен' ? 'success' : 'warning'}">
                    ${post.state}
                </span>
                ${post.editor_confirm ? 
                    '<span class="badge badge-info ml-2"><i class="fas fa-check"></i> Проверено</span>' : 
                    ''}
            `;
            cardBody.appendChild(status);
            
            // Добавляем кнопки управления
            const buttons = document.createElement('div');
            buttons.className = 'card-footer bg-transparent border-top-0';
            buttons.innerHTML = `
                <button class="btn btn-sm btn-outline-primary edit-post">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-success ml-2 toggle-confirm">
                    <i class="fas fa-check"></i>
                </button>
            `;
            
            // Добавляем обработчики
            buttons.querySelector('.edit-post').addEventListener('click', () => editPost(post, channelId));
            buttons.querySelector('.toggle-confirm').addEventListener('click', () => toggleConfirm(post, channelId));
            
            cardBody.appendChild(buttons);
            card.appendChild(cardBody);
            col.appendChild(card);
            
            return col;
        }

        function editPost(post, channelId) {
            const modal = $('#newPostModal');
            
            // Заполняем форму данными поста
            document.getElementById('postRow').value = post.row;
            document.getElementById('imageUrl').value = post.photo;
            document.getElementById('postText').value = post.text;
            document.getElementById('postDateTime').value = post.time.slice(0, 16); // Обрезаем до минут
            document.getElementById('editorConfirm').checked = post.editor_confirm;
            
            // Показываем превью изображения
            if (post.photo) {
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('imagePreview').querySelector('img').src = post.photo;
            }
            
            // Открываем модальное окно
            modal.modal('show');
        }

        function toggleConfirm(post, channelId) {
            const newConfirmState = !post.editor_confirm;
            
            fetch(`/api/channels/${channelId}/posts/${post.row}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ...post,
                    editor_confirm: newConfirmState
                })
            })
            .then(response => response.json())
            .then(() => {
                // Перезагружаем ленту
                loadChannelFeed(channelId);
            });
        }

        // Обработчики событий
        document.getElementById('channelSelector').addEventListener('change', function() {
            loadChannelFeed(this.value);
        });

        document.getElementById('generateText').addEventListener('click', function() {
            fetch('/api/generate-text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: document.getElementById('postText').value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('postText').value = data.text;
                }
            });
        });

        document.getElementById('savePost').addEventListener('click', function() {
            const channelId = document.getElementById('channelSelector').value;
            const row = document.getElementById('postRow').value;
            
            const postData = {
                photo: document.getElementById('imageUrl').value,
                text: document.getElementById('postText').value,
                time: document.getElementById('postDateTime').value,
                editor_confirm: document.getElementById('editorConfirm').checked
            };
            
            const url = row ? 
                `/api/channels/${channelId}/posts/${row}` : 
                `/api/channels/${channelId}/posts`;
                
            fetch(url, {
                method: row ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postData)
            })
            .then(response => response.json())
            .then(() => {
                $('#newPostModal').modal('hide');
                loadChannelFeed(channelId);
            });
        });

        // Обработка загрузки изображений
        document.getElementById('postImage').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('imagePreview').querySelector('img').src = e.target.result;
                    document.getElementById('imageUrl').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Загружаем каналы при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadChannelSelector();
        });

        function updateAnalytics() {
            fetch('/api/analytics')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка получения данных');
                    }
                    return response.json();
                })
                .then(response => {
                    if (!response.success) {
                        throw new Error(response.error || 'Неизвестная ошибка');
                    }
                    
                    const data = response.data;
                    
                    // Обновляем базовую статистику
                    updateBaseStats(data);
                    
                    // Обновляем спидометр активности
                    updateActivityGauge(data);
                    
                    // Обновляем тепловую карту
                    updateActivityHeatmap(data);
                    
                    // Обновляем графики эффективности
                    updateEfficiencyGauges(data);
                    
                    // Обновляем график активности
                    updateActivityChart(data);
                    
                    // Обновляем круговые диаграммы
                    updatePieCharts(data);
                    
                    // Обновляем прогноз роста
                    updateGrowthForecast(data);
                    
                    // Обновляем сигнальные лампы и тренды
                    updateSignalsAndTrends(data);
                })
                .catch(error => {
                    console.error('Ошибка при обновлении аналитики:', error);
                    alert('Произошла ошибка при загрузке аналитики: ' + error.message);
                });
        }

        function updateBaseStats(data) {
            // Обновляем основные счетчики
            document.getElementById('total-posts').textContent = data.total_posts;
            document.getElementById('posts-today').textContent = data.posts_today;
            document.getElementById('active-channels').textContent = data.active_channels;
            document.getElementById('total-reach').textContent = data.total_reach;
            
            // Обновляем прогресс-бары
            updateProgressBar('total-posts-progress', (data.total_posts / 1000) * 100);
            updateProgressBar('today-posts-progress', (data.posts_today / 10) * 100);
            updateProgressBar('channels-progress', (data.active_channels / 5) * 100);
            updateProgressBar('reach-progress', (data.total_reach / 10000) * 100);
        }

        function updateActivityGauge(data) {
            const value = calculateActivityScore(data);
            const gauge = {
                type: "indicator",
                mode: "gauge+number",
                value: value,
                title: { text: "Активность" },
                gauge: {
                    axis: { range: [0, 100] },
                    bar: { color: "darkblue" },
                    bgcolor: "white",
                    borderwidth: 2,
                    bordercolor: "gray",
                    steps: [
                        { range: [0, 30], color: "#ff6b6b" },
                        { range: [30, 70], color: "#ffd93d" },
                        { range: [70, 100], color: "#6bcb77" }
                    ],
                    threshold: {
                        line: { color: "red", width: 4 },
                        thickness: 0.75,
                        value: 90
                    }
                }
            };
            
            Plotly.newPlot('activity-gauge', [gauge], {
                width: 300,
                height: 200,
                margin: { t: 0, b: 0 }
            });
        }

        function updateActivityHeatmap(data) {
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            const hours = Array.from({length: 24}, (_, i) => i);
            
            const heatmapData = [{
                z: generateHeatmapData(data),
                x: hours,
                y: days,
                type: 'heatmap',
                colorscale: 'Viridis'
            }];
            
            const layout = {
                margin: { t: 20, r: 0, b: 30, l: 40 },
                xaxis: { title: 'Час' },
                yaxis: { title: 'День недели' }
            };
            
            Plotly.newPlot('activity-heatmap', heatmapData, layout);
        }

        function updateEfficiencyGauges(data) {
            // Gauge для вовлеченности
            const engagementGauge = {
                type: "indicator",
                mode: "gauge+number",
                value: calculateEngagement(data),
                title: { text: "Вовлеченность" },
                gauge: {
                    axis: { range: [0, 100] },
                    bar: { color: "#2196F3" },
                    steps: [
                        { range: [0, 30], color: "lightgray" },
                        { range: [30, 70], color: "gray" },
                        { range: [70, 100], color: "darkgray" }
                    ]
                }
            };
            
            // Gauge для оптимальности времени
            const timingGauge = {
                type: "indicator",
                mode: "gauge+number",
                value: calculateTimingScore(data),
                title: { text: "Время публикаций" },
                gauge: {
                    axis: { range: [0, 100] },
                    bar: { color: "#4CAF50" },
                    steps: [
                        { range: [0, 30], color: "lightgray" },
                        { range: [30, 70], color: "gray" },
                        { range: [70, 100], color: "darkgray" }
                    ]
                }
            };
            
            Plotly.newPlot('engagement-gauge', [engagementGauge], {
                margin: { t: 0, b: 0 }
            });
            
            Plotly.newPlot('timing-gauge', [timingGauge], {
                margin: { t: 0, b: 0 }
            });
        }

        function updateGrowthForecast(data) {
            const dates = generateForecastDates();
            const values = generateForecastValues(data);
            
            const trace = {
                x: dates,
                y: values,
                type: 'scatter',
                mode: 'lines+markers',
                line: {
                    color: '#2196F3',
                    width: 2,
                    dash: 'dot'
                },
                marker: {
                    size: 6,
                    color: '#2196F3'
                }
            };
            
            const layout = {
                margin: { t: 20, r: 20, b: 30, l: 40 },
                showlegend: false,
                xaxis: { title: 'Дата' },
                yaxis: { title: 'Прогноз постов' }
            };
            
            Plotly.newPlot('growth-forecast', [trace], layout);
        }

        function updateSignalsAndTrends(data) {
            // Обновляем сигнальные лампы
            updateSignalLamp('total-posts-signal', data.total_posts, 100);
            updateSignalLamp('today-posts-signal', data.posts_today, 5);
            updateSignalLamp('channels-signal', data.active_channels, 3);
            updateSignalLamp('reach-signal', data.total_reach, 1000);
            
            // Обновляем тренды
            updateTrend('total-posts-trend', calculateTrend(data.total_posts_history));
            updateTrend('today-posts-trend', calculateTrend(data.today_posts_history));
            updateTrend('channels-trend', calculateTrend(data.channels_history));
            updateTrend('reach-trend', calculateTrend(data.reach_history));
        }

        // Вспомогательные функции
        function updateProgressBar(id, percentage) {
            const element = document.getElementById(id);
            element.style.width = `${Math.min(100, percentage)}%`;
        }

        function updateSignalLamp(id, value, threshold) {
            const element = document.getElementById(id);
            element.className = 'signal-lamp';
            
            if (value >= threshold) {
                element.classList.add('green');
            } else if (value >= threshold * 0.6) {
                element.classList.add('yellow');
            } else {
                element.classList.add('red');
            }
        }

        function updateTrend(id, trend) {
            const element = document.getElementById(id);
            if (trend > 0) {
                element.innerHTML = `<i class="fas fa-arrow-up text-success"></i> +${trend}%`;
            } else if (trend < 0) {
                element.innerHTML = `<i class="fas fa-arrow-down text-danger"></i> ${trend}%`;
            } else {
                element.innerHTML = `<i class="fas fa-minus text-muted"></i> 0%`;
            }
        }

        function calculateActivityScore(data) {
            return Math.min(100, (data.posts_today / 10) * 100);
        }

        function generateHeatmapData(data) {
            // Заглушка для демонстрации
            return Array.from({length: 7}, () => 
                Array.from({length: 24}, () => 
                    Math.floor(Math.random() * 10)
                )
            );
        }

        function calculateEngagement(data) {
            return Math.min(100, (data.total_reach / data.total_posts) / 100);
        }

        function calculateTimingScore(data) {
            // Заглушка для демонстрации
            return Math.floor(Math.random() * 100);
        }

        function generateForecastDates() {
            const dates = [];
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                dates.push(date.toLocaleDateString());
            }
            return dates;
        }

        function generateForecastValues(data) {
            const baseValue = data.total_posts;
            return Array.from({length: 7}, (_, i) => 
                Math.floor(baseValue * (1 + (i * 0.1)))
            );
        }

        function calculateTrend(history) {
            // Заглушка для демонстрации
            return Math.floor(Math.random() * 21) - 10;
        }
    </script>
</body>
</html> 