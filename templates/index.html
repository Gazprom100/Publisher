<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher Dashboard</title>
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #FFC107;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --sidebar-width: 250px;
        }

        body {
            background-color: #f5f5f5;
            transition: background-color 0.3s;
        }

        body.dark-theme {
            background-color: #121212;
            color: #ffffff;
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background-color: #ffffff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: all 0.3s;
        }

        .dark-theme .sidebar {
            background-color: #1e1e1e;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: margin-left 0.3s;
        }

        .stats-card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .dark-theme .stats-card {
            background-color: #2d2d2d;
            color: #ffffff;
        }

        .chart-container {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .dark-theme .chart-container {
            background-color: #2d2d2d;
        }

        .channel-card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .channel-card:hover {
            transform: scale(1.02);
        }

        .dark-theme .channel-card {
            background-color: #2d2d2d;
        }

        .theme-switch {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .floating-action-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            padding: 3px 6px;
            border-radius: 50%;
            background: var(--danger-color);
            color: white;
            font-size: 12px;
        }

        .schedule-timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            position: relative;
            padding: 15px;
            margin-left: 30px;
            border-left: 2px solid var(--primary-color);
            margin-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 20px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--primary-color);
        }
    </style>
    <!-- Scripts -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
    <!-- Боковое меню -->
    <div class="sidebar">
        <div class="p-4">
            <h4 class="mb-4">
                <i class="material-icons">publish</i>
                Publisher
            </h4>
            <div class="list-group list-group-flush">
                <a href="#dashboard" class="list-group-item list-group-item-action active">
                    <i class="material-icons">dashboard</i>
                    Дашборд
                </a>
                <a href="#analytics" class="list-group-item list-group-item-action">
                    <i class="material-icons">analytics</i>
                    Аналитика
                </a>
                <a href="#channels" class="list-group-item list-group-item-action">
                    <i class="material-icons">rss_feed</i>
                    Каналы
                </a>
                <a href="#schedule" class="list-group-item list-group-item-action">
                    <i class="material-icons">schedule</i>
                    Расписание
                </a>
                <a href="#settings" class="list-group-item list-group-item-action">
                    <i class="material-icons">settings</i>
                    Настройки
                </a>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="main-content">
        <!-- Дашборд -->
        <section id="dashboard" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Дашборд</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" id="refreshData">
                        <i class="material-icons">refresh</i>
                        Обновить
                    </button>
                    <button class="btn btn-primary" data-mdb-toggle="modal" data-mdb-target="#newPostModal">
                        <i class="material-icons">add</i>
                        Новый пост
                    </button>
                </div>
            </div>

            <!-- Статистика -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stats-card card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-muted">Всего постов</h6>
                                    <h3 id="total-posts">0</h3>
                                </div>
                                <i class="material-icons text-primary">article</i>
                            </div>
                            <div class="progress mt-3" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" style="width: 70%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-muted">Сегодня</h6>
                                    <h3 id="posts-today">0</h3>
                                </div>
                                <i class="material-icons text-success">today</i>
                            </div>
                            <div class="progress mt-3" style="height: 5px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 50%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-muted">Активные каналы</h6>
                                    <h3 id="active-channels">0</h3>
                                </div>
                                <i class="material-icons text-warning">rss_feed</i>
                            </div>
                            <div class="progress mt-3" style="height: 5px;">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 80%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-muted">Охват</h6>
                                    <h3 id="total-reach">0</h3>
                                </div>
                                <i class="material-icons text-info">people</i>
                            </div>
                            <div class="progress mt-3" style="height: 5px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 60%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Графики -->
            <div class="row g-4 mb-4">
                <div class="col-md-8">
                    <div class="chart-container">
                        <h5>Активность по времени</h5>
                        <div id="activity-chart"></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="chart-container">
                        <h5>Типы контента</h5>
                        <div id="content-types-chart"></div>
                    </div>
                </div>
            </div>

            <!-- Ближайшие публикации -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Ближайшие публикации</h5>
                    <div class="schedule-timeline" id="upcoming-posts">
                        <!-- Динамическое содержимое -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Секция управления каналами -->
        <div id="channels" class="section mb-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h2>Управление каналами</h2>
                <button class="btn btn-primary" data-toggle="modal" data-target="#addChannelModal">
                    <i class="fas fa-plus"></i> Добавить канал
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-sm" id="channelsTable">
                    <thead>
                        <tr>
                            <th>Название канала</th>
                            <th>ID канала</th>
                            <th>Лист</th>
                            <th>Подписчики</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Данные о каналах будут добавлены динамически -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Модальное окно нового поста -->
    <div class="modal fade" id="newPostModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Новый пост</h5>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newPostForm">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-outline">
                                    <input type="date" id="postDate" class="form-control" required />
                                    <label class="form-label" for="postDate">Дата публикации</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-outline">
                                    <input type="time" id="postTime" class="form-control" required />
                                    <label class="form-label" for="postTime">Время публикации</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-outline mb-4">
                            <select class="form-control" id="postChannel" required>
                                <option value="">Выберите канал</option>
                            </select>
                            <label class="form-label" for="postChannel">Канал</label>
                        </div>

                        <div class="mb-4">
                            <div class="form-outline">
                                <input type="url" id="postPhoto" class="form-control" />
                                <label class="form-label" for="postPhoto">URL изображения</label>
                            </div>
                            <small class="form-text">Необязательно. Максимальный размер: 5MB</small>
                            <button type="button" class="btn btn-link" id="validateImage">
                                Проверить изображение
                            </button>
                        </div>

                        <div class="mb-4" id="photoPreview" style="display: none;">
                            <img src="" alt="Preview" class="img-fluid rounded" />
                        </div>

                        <div class="form-outline mb-4">
                            <textarea class="form-control" id="postText" rows="5" required></textarea>
                            <label class="form-label" for="postText">Текст поста</label>
                            <small class="form-text">
                                <span id="charCount">0</span>/2000 символов
                            </small>
                        </div>

                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="postAnalysis" />
                            <label class="form-check-label" for="postAnalysis">
                                Анализировать пост перед публикацией
                            </label>
                        </div>

                        <div class="alert alert-info" id="postAnalysisResult" style="display: none;">
                            <!-- Результаты анализа -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="savePost">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления канала -->
    <div class="modal fade" id="addChannelModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить новый канал</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addChannelForm">
                        <div class="form-group">
                            <label for="channelId">ID канала</label>
                            <input type="text" class="form-control" id="channelId" required
                                   placeholder="Например: @mychannel">
                            <small class="form-text text-muted">Укажите ID канала, включая символ @</small>
                        </div>
                        <div class="form-group">
                            <label for="sheetName">Название листа</label>
                            <input type="text" class="form-control" id="sheetName" required
                                   placeholder="Например: Channel1">
                            <small class="form-text text-muted">Название листа в Google Sheets</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="saveChannel">Добавить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Кнопка переключения темы -->
    <button class="btn btn-floating btn-primary theme-switch" id="themeSwitch">
        <i class="material-icons">dark_mode</i>
    </button>

    <!-- MDB JS -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.js"></script>
    
    <script>
        // Инициализация Socket.IO
        const socket = io();

        // Переключение темы
        const themeSwitch = document.getElementById('themeSwitch');
        themeSwitch.addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            const icon = themeSwitch.querySelector('i');
            icon.textContent = document.body.classList.contains('dark-theme') ? 'light_mode' : 'dark_mode';
        });

        // Обновление данных в реальном времени
        socket.on('posts_update', function(data) {
            updateDashboard(data.posts);
        });

        // Функции обновления интерфейса
        function updateDashboard(posts) {
            updateStatistics(posts);
            updateActivityChart(posts);
            updateContentTypesChart(posts);
            updateUpcomingPosts(posts);
        }

        function updateStatistics(posts) {
            const now = new Date();
            const today = posts.filter(p => new Date(p.time).toDateString() === now.toDateString()).length;
            const total = posts.length;
            const activeChannels = new Set(posts.map(p => p.channel)).size;
            const reach = calculateTotalReach(posts);

            document.getElementById('total-posts').textContent = total;
            document.getElementById('posts-today').textContent = today;
            document.getElementById('active-channels').textContent = activeChannels;
            document.getElementById('total-reach').textContent = reach.toLocaleString();
        }

        function updateActivityChart(posts) {
            const hours = Array.from({length: 24}, (_, i) => i);
            const counts = hours.map(hour => 
                posts.filter(p => new Date(p.time).getHours() === hour).length
            );

            const trace = {
                x: hours,
                y: counts,
                type: 'scatter',
                mode: 'lines+markers',
                line: {
                    color: '#2196F3',
                    width: 2
                },
                marker: {
                    color: '#2196F3',
                    size: 6
                }
            };

            const layout = {
                margin: { t: 20, r: 20, b: 40, l: 40 },
                xaxis: {
                    title: 'Час',
                    tickmode: 'array',
                    ticktext: hours.map(h => h.toString().padStart(2, '0') + ':00'),
                    tickvals: hours
                },
                yaxis: {
                    title: 'Количество постов'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                showlegend: false
            };

            Plotly.newPlot('activity-chart', [trace], layout);
        }

        function updateContentTypesChart(posts) {
            const withPhoto = posts.filter(p => p.photo).length;
            const textOnly = posts.length - withPhoto;

            const data = [{
                values: [withPhoto, textOnly],
                labels: ['С фото', 'Только текст'],
                type: 'pie',
                hole: .4,
                marker: {
                    colors: ['#2196F3', '#FFC107']
                }
            }];

            const layout = {
                margin: { t: 20, r: 20, b: 20, l: 20 },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.1
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('content-types-chart', data, layout);
        }

        function updateUpcomingPosts(posts) {
            const now = new Date();
            const upcoming = posts
                .filter(p => new Date(p.time) > now && p.state === 'ожидает')
                .sort((a, b) => new Date(a.time) - new Date(b.time))
                .slice(0, 5);

            const container = document.getElementById('upcoming-posts');
            container.innerHTML = upcoming.map(post => `
                <div class="timeline-item">
                    <div class="d-flex justify-content-between">
                        <h6>${post.channel}</h6>
                        <small>${new Date(post.time).toLocaleString()}</small>
                    </div>
                    <p class="mb-0">${post.text.substring(0, 100)}${post.text.length > 100 ? '...' : ''}</p>
                    ${post.photo ? '<i class="material-icons text-info">image</i>' : ''}
                </div>
            `).join('');
        }

        // Обработка формы нового поста
        document.getElementById('postText').addEventListener('input', function() {
            const charCount = this.value.length;
            document.getElementById('charCount').textContent = charCount;
            if (charCount > 2000) {
                this.value = this.value.substring(0, 2000);
            }
        });

        document.getElementById('validateImage').addEventListener('click', async function() {
            const photoUrl = document.getElementById('postPhoto').value;
            if (!photoUrl) return;

            try {
                const response = await fetch('/api/validate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: photoUrl })
                });
                const data = await response.json();

                if (data.valid) {
                    document.getElementById('photoPreview').style.display = 'block';
                    document.getElementById('photoPreview').querySelector('img').src = photoUrl;
                } else {
                    alert('Неверный формат изображения или превышен размер');
                }
            } catch (error) {
                console.error('Ошибка при проверке изображения:', error);
                alert('Ошибка при проверке изображения');
            }
        });

        document.getElementById('postAnalysis').addEventListener('change', async function() {
            if (!this.checked) {
                document.getElementById('postAnalysisResult').style.display = 'none';
                return;
            }

            const text = document.getElementById('postText').value;
            const photo = document.getElementById('postPhoto').value;

            try {
                const response = await fetch('/api/analyze-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        photo: photo,
                        time: new Date(
                            document.getElementById('postDate').value + 'T' +
                            document.getElementById('postTime').value
                        )
                    })
                });
                const analysis = await response.json();

                const result = document.getElementById('postAnalysisResult');
                result.style.display = 'block';
                result.innerHTML = `
                    <h6>Результаты анализа:</h6>
                    <p>Оценка: ${analysis.score}/3</p>
                    ${analysis.feedback.map(f => `<p>• ${f}</p>`).join('')}
                    ${analysis.optimization_tips.length > 0 ? `
                        <h6>Рекомендации по улучшению:</h6>
                        ${analysis.optimization_tips.map(tip => `<p>• ${tip}</p>`).join('')}
                    ` : ''}
                `;
            } catch (error) {
                console.error('Ошибка при анализе поста:', error);
                alert('Ошибка при анализе поста');
            }
        });

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const [analyticsResponse, channelsResponse, scheduleResponse] = await Promise.all([
                    fetch('/api/analytics'),
                    fetch('/api/channel-health'),
                    fetch('/api/schedule-preview')
                ]);

                const [analytics, channels, schedule] = await Promise.all([
                    analyticsResponse.json(),
                    channelsResponse.json(),
                    scheduleResponse.json()
                ]);

                updateDashboard({
                    posts: analytics.posts || [],
                    channels: channels || {},
                    schedule: schedule || []
                });

                // Заполнение списка каналов
                const channelSelect = document.getElementById('postChannel');
                Object.keys(channels).forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel;
                    option.textContent = channel;
                    channelSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка при загрузке данных:', error);
            }
        });

        // Вспомогательные функции
        function calculateTotalReach(posts) {
            const channels = {};
            posts.forEach(post => {
                if (!channels[post.channel]) {
                    channels[post.channel] = true;
                }
            });
            // Примерный расчет охвата (можно заменить на реальные данные)
            return Object.keys(channels).length * 1000;
        }

        // Функции для работы с каналами
        function loadChannels() {
            fetch('/api/channels')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector('#channelsTable tbody');
                    tbody.innerHTML = '';
                    
                    Object.entries(data).forEach(([channelId, info]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${info.title || 'Н/Д'}</td>
                            <td>${channelId}</td>
                            <td>${info.sheet_name}</td>
                            <td>${info.member_count || 'Н/Д'}</td>
                            <td>
                                <span class="badge badge-${info.status === 'active' ? 'success' : 'danger'}">
                                    ${info.status}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-danger delete-channel" data-channel="${channelId}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Добавляем обработчики для кнопок удаления
                    document.querySelectorAll('.delete-channel').forEach(button => {
                        button.addEventListener('click', function() {
                            const channelId = this.dataset.channel;
                            if (confirm(`Удалить канал ${channelId}?`)) {
                                deleteChannel(channelId);
                            }
                        });
                    });
                })
                .catch(error => console.error('Ошибка загрузки каналов:', error));
        }

        function addChannel(channelId, sheetName) {
            fetch('/api/channels', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    channel_id: channelId,
                    sheet_name: sheetName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Ошибка: ' + data.error);
                } else {
                    $('#addChannelModal').modal('hide');
                    loadChannels();
                    document.getElementById('addChannelForm').reset();
                }
            })
            .catch(error => {
                console.error('Ошибка добавления канала:', error);
                alert('Произошла ошибка при добавлении канала');
            });
        }

        function deleteChannel(channelId) {
            fetch(`/api/channels/${channelId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Ошибка: ' + data.error);
                } else {
                    loadChannels();
                }
            })
            .catch(error => {
                console.error('Ошибка удаления канала:', error);
                alert('Произошла ошибка при удалении канала');
            });
        }

        // Обработчики событий
        document.getElementById('saveChannel').addEventListener('click', function() {
            const channelId = document.getElementById('channelId').value;
            const sheetName = document.getElementById('sheetName').value;
            
            if (!channelId || !sheetName) {
                alert('Заполните все поля');
                return;
            }
            
            addChannel(channelId, sheetName);
        });

        // Загружаем каналы при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadChannels();
        });
    </script>
</body>
</html> 